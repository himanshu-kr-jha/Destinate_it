<% layout("layouts/boilerplate") %>

<body>
    <div class="container mt-3">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="display-4">
                    <%= list.title %>
                </h1>
            </div>
        </div>
        <div class="row mt-3 justify-content-center">
            <div class="card col-md-8 show-card">
                <div class="image-container">
                    <img class="card-img-top img-fluid show-img" src="<%= list.image %>" alt="Card image cap">
                </div>
                <div class="card-body">
                    <p class="card-text">Credits <i>@<%= list.owner.username %><i></p>
                    <p class="card-text">
                        <%= list.description %> <br><br> </p>
                    <p class="card-text"><b><span style="color: #222222;">&#8377; <%= list.price.toLocaleString("en-IN") %></span></b><br></p>
                    <p class="card-text"><%= list.location %>, <%= list.country %><br></p>
                </div>
            </div>
        </div>
        <% if (currUser) { %>
            <div class="row mt-3 justify-content-center">
                <div class="col-md-6 text-center">
                    <a href="/listing/<%= list._id %>/edit" class="btn btn-dark col-4 mx-2">Edit</a>
                    <form id="deleteForm" action="/listing/<%= list._id %>?_method=DELETE" method="POST" class="d-inline">
                        <button type="button" class="btn btn-danger col-4 mx-2" onclick="confirmDelete()">Delete</button>
                    </form>
                </div>
            </div>
            <% } %>
        <hr>

        <% if (currUser) { %>
        <div class="row mt-5 mb-3 justify-content-center">
            <div class="col-md-6">
                <h4 class="text-center">Leave a review</h4>
                <form action="/listing/<%= list._id %>/reviews" method="post" novalidate class="needs-validation">
                    <div class="form-group">
                        <label for="rating" class="form-label">Rating</label>
                        <input type="range" class="form-control-range" min="1" max="5" id="rating" name="review[rating]">
                    </div>
                    <div class="form-group">
                        <label for="comment" class="form-label">Comments</label>
                        <textarea class="form-control" name="review[comment]" id="comment" cols="30" rows="5" required></textarea>
                        <div class="valid-feedback">Thank you for your review !!</div>
                        <div class="invalid-feedback">Comment is empty. Please provide your valuable reviews !!</div>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-dark">Submit</button>
                    </div>
                </form>
            </div>
        </div>
        <% } %>
        <div class="row mt-5 mb-3">
            <div class="col-12">
                <h4>All reviews</h4>
                <div class="row">
                    <% for(let i = 0; i < list.reviews.length; i++) { 
                        let review = list.reviews[i]; 
                    %>
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title"><b><%= review.author.username%></h5> </b> <small class="text-muted"><%= new Date(review.createdAt).toLocaleString("en-IN", { dateStyle: 'medium', timeStyle: 'short' }) %></small>
                                    <p class="card-text">
                                        Rating: 
                                        <% for (let i = 1; i <= 5; i++) { %>
                                            <% if (i <= review.rating) { %>
                                                &#9733; <!-- Filled star -->
                                            <% } else { %>
                                                &#9734; <!-- Empty star -->
                                            <% } %>
                                        <% } %>
                                    </p>
                                    <p class="card-text"><%= review.comment %></p>
                                    <form method="post" action="/listing/<%=list._id%>/reviews/<%=review._id%>/?_method=DELETE">
                                        <button class="btn btn-outline-danger">Delete</button>
                                    </form>
                                </div>
                                    
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmDelete() {
            if (confirm("Are you sure you want to delete this listing?")) {
                document.getElementById("deleteForm").submit();
            }
        }
    </script>
</body>

<style>
    .image-container {
        width: 100%;
        max-height: 400px;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 10px;
    }

    .show-card {
        border-radius: 10px;
    }

    .show-img {
        width: 100%;
        height: auto;
        object-fit: contain;
        border-radius: 10px;
    }

    .card {
        border-radius: 10px;
    }

    .card-text {
        font-size: 1.2rem;
    }
</style>
